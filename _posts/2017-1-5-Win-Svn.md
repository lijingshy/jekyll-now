* * *

layout: post
title: Window编译svn源码
date: 2017-01-04 13:50:00
tags:

*   win32
*   svn
categories: svn
description: 在window下搭建环境编译svn。

* * *

# Window编译svn源码

## 安装编译环境

1.  安装msys2-i686
2.  安装mingw-w64，直接解压mingw32到msys2目录下，覆盖同名目录

启动msys2，which gcc查看gcc是否正确，使用以下安装必须的程序

    pacman -Su
    pacman -S <span class="hljs-keyword">vim</span>
    pacman -S <span class="hljs-keyword">perl</span>
    pacman -S unzip
    pacman -<span class="hljs-keyword">s</span> <span class="hljs-keyword">python</span>
    pacman -S <span class="hljs-keyword">vim</span>
    `</pre>

    ## 编译依赖包

    ### zlib128.zip

    下载并解压源码

    <pre>`cd zlib-<span class="hljs-number">1.2</span>.<span class="hljs-number">8</span>
    sed -<span class="hljs-tag">i</span> <span class="hljs-string">"s,SHARED_MODE=0,SHARED_MODE=1,"</span> win32/Makefile<span class="hljs-class">.gcc</span>
    make -f win32/Makefile<span class="hljs-class">.gcc</span>
    make -f win32/Makefile<span class="hljs-class">.gcc</span> install DESTDIR=<span class="hljs-variable">$PREFIX</span> INCLUDE_PATH=/include LIBRARY_PATH=/lib BINARY_PATH=/bin
    `</pre>

    ### apr-1.5.2

    下载解压源码，先打[patch](../attach/apr-0.patch),然后编译

    <pre>`<span class="hljs-comment">cd</span> <span class="hljs-comment">apr</span><span class="hljs-literal">-</span><span class="hljs-comment">1</span><span class="hljs-string">.</span><span class="hljs-comment">5</span><span class="hljs-string">.</span><span class="hljs-comment">2</span>
    <span class="hljs-comment">patch</span> <span class="hljs-literal">-</span><span class="hljs-comment">p0</span> <<span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-comment">/apr</span><span class="hljs-literal">-</span><span class="hljs-comment">0</span><span class="hljs-string">.</span><span class="hljs-comment">patch</span>
    <span class="hljs-string">.</span><span class="hljs-comment">/buildconf</span>
    <span class="hljs-string">.</span><span class="hljs-comment">/configure</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">enable</span><span class="hljs-literal">-</span><span class="hljs-comment">shared=yes</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">disable</span><span class="hljs-literal">-</span><span class="hljs-comment">static</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">prefix=$PREFIX</span>
    <span class="hljs-comment">make</span> 
    <span class="hljs-comment">make</span> <span class="hljs-comment">install</span>
    `</pre>

    ### apr-util-1.5.4

    下载并解压源码，然后编译

    <pre>`<span class="hljs-comment">cd</span> <span class="hljs-comment">apr</span><span class="hljs-literal">-</span><span class="hljs-comment">util</span><span class="hljs-literal">-</span><span class="hljs-comment">1</span><span class="hljs-string">.</span><span class="hljs-comment">5</span><span class="hljs-string">.</span><span class="hljs-comment">4</span>
    <span class="hljs-string">.</span><span class="hljs-comment">/buildconf</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">with</span><span class="hljs-literal">-</span><span class="hljs-comment">apr=</span><span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-comment">/apr</span><span class="hljs-literal">-</span><span class="hljs-comment">1</span><span class="hljs-string">.</span><span class="hljs-comment">5</span><span class="hljs-string">.</span><span class="hljs-comment">2</span>
    <span class="hljs-string">.</span><span class="hljs-comment">/configure</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">prefix=$PREFIX</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">with</span><span class="hljs-literal">-</span><span class="hljs-comment">apr=$PREFIX</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">without</span><span class="hljs-literal">-</span><span class="hljs-comment">iconv</span>
    <span class="hljs-comment">make</span>
    <span class="hljs-comment">make</span> <span class="hljs-comment">install</span>
    `</pre>

    ### subversion-1.9.3

    下载并解压源码，同时下载sqlite-amalgamation-3071501.zip并解压到subversion源码目录，改名为sqlite-amalgamation,然后准备修改编译

    <pre>`vi configure.ac
    delete；
    470 SVN_LIB_MACHO_ITERATE
    471 SVN_LIB_MACOS_PLIST
    472 SVN_LIB_MACOS_KEYCHAIN
    1274 PYTHON="`$abs_srcdir/build/find_python.sh`"

    vi subversion/libsvn_subr/config_win.c
    replace #include <Ws2tcpip.h> to #include <ws2tcpip.h>

    vi subversion/libsvn_subr/win32_xlate.c
    replace #include <Ws2tcpip.h> to #include <ws2tcpip.h>
    <span class="hljs-chunk">@@ -53,6 +53,8 @@</span>

     #include "svn_private_config.h"

    <span class="hljs-addition">+#define INITGUID 1</span>
    <span class="hljs-addition">+DEFINE_GUID (IID_IMultiLanguage, 0x275c23e1,0x3747,0x11d0,0x9f,0xea,0x00,0xaa,0x00,0x3f,0x86,0x46);</span>
     static svn_atomic_t com_initialized = 0;

     /* Initializes COM and keeps COM available until process exit.
    <span class="hljs-chunk">@@ -139,10 +139,12 @@</span>
           return saved; /* probably SVN_ERR_ATOMIC_INIT_FAILURE */
         }

    <span class="hljs-addition">+#if 0</span>
           hr = CoCreateInstance(&CLSID_CMultiLanguage, NULL, CLSCTX_INPROC_SERVER,
                         &IID_IMultiLanguage, (void **) &mlang);

           if (FAILED(hr))
    <span class="hljs-addition">+#endif</span>
         return APR_EGENERAL;

           /* Convert page name to wide string. */

    vi subversion/libsvn_subr/io.c
    <span class="hljs-chunk">@@ -1789,7 +1789,7 @@</span>
         }
     }

    <span class="hljs-deletion">-    SVN_ERR(svn_utf__win32_utf8_to_utf16(&(const WCHAR*)buffer, source,</span>
    <span class="hljs-addition">+    SVN_ERR(svn_utf__win32_utf8_to_utf16((const WCHAR**)&buffer, source,</span>
                                          prefix, result_pool));

     /* Convert slashes to backslashes because the \\?\ path format

    vi build/generator/gen_make.py
    <span class="hljs-chunk">@@ -633,7 +633,7 @@</span>
         lib_required_private=[],
         )
       # libsvn_foo -> -lsvn_foo
    <span class="hljs-deletion">-      data.lib_deps.append('-l%s' % lib_name.replace('lib', '', 1))</span>
    <span class="hljs-addition">+      data.lib_deps.append('-l%s-1' % lib_name.replace('lib', '', 1))</span>
       for lib_dep in lib_deps.split():
         if lib_dep == 'apriconv':
           # apriconv is part of apr-util, skip it

    vi build/generator/templates/pkg-config.in.ezt
    <span class="hljs-chunk">@@ -1,7 +1,7 @@</span>
     prefix=@prefix@
     exec_prefix=@exec_prefix@
     libdir=@libdir@
    <span class="hljs-deletion">-includedir=@includedir@</span>
    <span class="hljs-addition">+includedir=@includedir@/subversion-1</span>

     ./autogen.sh
     vi configure
     -6530   sqlite_amalg="$abs_srcdir/sqlite-amalgamation/sqlite3.c"
     +6530   sqlite_amalg="sqlite-amalgamation/sqlite3.c"
     ./configure --prefix=$PREFIX --with-apr=$PREFIX --with-apr-util=$PREFIX --with-zlib=$PREFIX --enable-static=no --enable-shared=yes --disable-nls --without-serf  --without-apxs --without-gpg-agent --without-gnome-keyring --without-swig
     vi libtool
     -388 allow_undefined_flag="unsupported"
     -388 allow_undefined_flag="yes"
     vi Makefile
    <span class="hljs-deletion">-  58 LIBS =</span>
    <span class="hljs-addition">+  58 LIBS =  -lversion -lole32</span>

    make
    make install

* * *

**编译完成**